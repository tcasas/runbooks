# Sectigo SPKI mismatch troubleshooting (IPython)

Use this runbook inside IPython immediately after running `%run app/tests/repl/issue_sectigo_cert.py` to diagnose why the returned certificate from Sectigo does not match the CSR generated by Turtle Sensor.

## Prerequisites
- IPython session in the project environment.
- `app/tests/repl/issue_sectigo_cert.py` has been executed, leaving the globals `LAST_CERTFILE`, `LAST_F5CERT`, `LAST_RESULT`, and `LAST_EXCEPTION` in memory.

## Collect diagnostic context
1. **Import helpers and capture objects**:
   ```python
   from app.utils.pem_utils import PemUtilsMixin

   cf = LAST_CERTFILE
   fc = LAST_F5CERT
   sgo = fc.sgo_client
   ```
2. **Print the CertFile identity** to confirm the basic parameters and stored SPKIs:
   ```python
   print("=== CertFile Identity ===")
   print("CN:", cf.cn)
   print("scope_key:", cf.scope_key)
   print("csr_spki_sha256:", cf.csr_spki_sha256)
   print("cert_spki_sha256:", cf.cert_spki_sha256)
   print("pending_state:", cf.pending_state)
   print("sgo_id:", getattr(cf, "sgo_id", None))
   print("sgo_spki:", getattr(cf, "sgo_spki", None))
   print("csr_locked:", getattr(cf, "csr_locked", None))
   print("sgo_locked:", getattr(cf, "sgo_locked", None))
   ```
   - Expected: `CN = enrolltest.opentext.cloud`, `csr_spki_sha256` present, `sgo_id` populated, and `sgo_spki` matching the CSR SPKI.

## Recompute CSR SPKI
1. **Recalculate and compare the stored CSR SPKI**:
   ```python
   csr_spki_recalc = PemUtilsMixin.compute_spki(cf.csr_pem)
   print("csr_spki_recalc:", csr_spki_recalc)
   print("MATCH stored?", csr_spki_recalc == cf.csr_spki_sha256)
   ```
   - If `MATCH stored?` is `False`, the CSR saved in CertFile is not the CSR that was generated for the key. This is the most common cause of SPKI mismatches.

## Validate private key ↔ CSR relationship
1. **Confirm the private key matches the CSR**:
   ```python
   try:
       key_spki = PemUtilsMixin.compute_spki_from_private_key(cf.key_pem)
       print("key_spki:", key_spki)
       print("CSR ↔ Key SPKI MATCH?", key_spki == csr_spki_recalc)
   except Exception as ex:
       print("Could not compute key SPKI:", ex)
   ```
   - If the match is `False`, `cf.key_pem` does not correspond to the CSR—often due to duplicate CertFiles or stale material.

## Verify returned certificate SPKI
1. **Check the stored certificate and compare SPKIs**:
   ```python
   print("crt_pem present?", bool(cf.crt_pem))
   if cf.crt_pem:
       crt_spki = PemUtilsMixin.compute_spki(cf.crt_pem)
       print("crt_spki:", crt_spki)
       print("CERT ↔ CSR SPKI MATCH?", crt_spki == csr_spki_recalc)
   else:
       print("No certificate PEM stored in certfile")
   ```
   - If the match is `False`, Sectigo likely returned a certificate for a different order or you collected against the wrong `sgo_id`.

## Check CertFile SPKI agreement
1. **Confirm stored CSR and cert SPKIs align**:
   ```python
   print("csr_spki:", cf.csr_spki_sha256)
   print("cert_spki:", cf.cert_spki_sha256)
   print("cert_spki == csr_spki?", cf.cert_spki_sha256 == cf.csr_spki_sha256)
   ```
   - Expected: `cert_spki == csr_spki` is `True`. If `False`, CertFile accepted a certificate that does not match the CSR, indicating missing SPKI enforcement or concurrency issues.

## Inspect the last Sectigo collect response
1. **Review the raw collect response to validate order matching**:
   ```python
   raw = getattr(sgo, "last_collect_response", None)
   print("=== last_collect_response ===")
   print(raw)
   ```
   - Verify `orderNumber` equals `cf.sgo_id` and that the returned certificate public key matches the CSR SPKI. Confirm the chain is attached.

## Dump full CertFile for cross-validation
1. **Print the CertFile object** to spot duplicate scope keys or stale states:
   ```python
   print("CertFile:", cf)
   ```
   - Look for duplicate `scope_key` values in the same workflow, unexpected `pending_state` transitions, or provisional/stale certificate material.

## Interpretation guide
- **CSR SPKI recalculation mismatches stored SPKI**: wrong CSR saved or overwritten.
- **Key SPKI mismatches CSR SPKI**: `key_pem` belongs to a different CertFile or was regenerated.
- **Cert SPKI mismatches CSR SPKI**: Sectigo returned a certificate for a different order; you likely collected the wrong `sgo_id`.
- **`sgo_id` != `last_collect_response.orderNumber`**: a previous/stale Sectigo order was collected.
- **Two CertFiles created in one run**: duplicate `scope_key` selection led to the wrong CertFile.

## Remediation actions
1. Enforce `certfile.csr_locked = True` immediately after CSR generation.
2. Persist both `certfile.sgo_id` and `certfile.sgo_spki = csr_spki` at enrollment time.
3. Enforce SPKI equality in `collect_cert()` before accepting a certificate.
4. Block duplicate CertFiles per workflow run.
5. Re-run `%run app/tests/repl/issue_sectigo_cert.py` and ensure all SPKI match checks pass (CSR ↔ key, CSR ↔ cert, and cert ↔ `sgo_id`).

## Manual OpenSSL verification (certificate ↔ private key)
Use these commands outside Python to verify the returned certificate matches the private key, and optionally the CSR.

1. **Extract public keys**:
   ```bash
   openssl x509 -in cert.crt -noout -pubkey > cert.pub
   openssl rsa  -in key.pem  -pubout > key.pub  # provide password if prompted
   ```
2. **Compare SPKI hashes (authoritative match)**:
   ```bash
   openssl pkey -in cert.pub -pubin -outform DER | sha256sum
   openssl pkey -in key.pub  -pubin -outform DER | sha256sum
   ```
   - Expected: hashes are identical → certificate and key match. If different, they are mismatched.
3. **Optional: Compare RSA modulus (secondary proof)**:
   ```bash
   openssl x509 -in cert.crt -noout -modulus | openssl dgst -sha256
   openssl rsa  -in key.pem  -noout -modulus | openssl dgst -sha256
   ```
   - Expected: hashes are identical → certificate and key share the same modulus.
4. **Optional: Verify CSR ↔ key ↔ certificate (full triad)**:
   ```bash
   openssl req  -in req.csr  -noout -pubkey | openssl pkey -pubin -outform DER | sha256sum
   openssl x509 -in cert.crt -noout -pubkey | openssl pkey -pubin -outform DER | sha256sum
   ```
   - Expected: CSR hash == key hash == cert hash → all materials match.
